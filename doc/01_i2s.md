# I2S

Das I2S Interface wird verwendet um mit dem PCM5102 Audio Codec zu kommunizieren.

## Double Buffering

Um Moeglichst einen effizienten Outputstream an den DAC zu ermoeglichen, wird Double Buffering verwendet.
Hierbei liest FatFS eine Buffergroeße in die untere Hälfte des Buffers ein, während die obere Hälfte des Buffers von der DMA über I2S an den Audio-Codec übertragen wird.

Referenz: https://www.eetimes.com/fundamentals-of-embedded-audio-part-3/

## DMA

Um Performance zu garantieren wird die DMA genutzt, um Daten aus dem Audiobuffer an den Audio Codec zu senden. 
Hierbei ist die Datawidth: Half Word (16bit), da mit 16bit quantisierten Audiodateien gearbeitet wird.

(reference: https://www.youtube.com/watch?v=zlGSxZGwj-E&t=47s)

## SCK

SCK (System Clock) für den PCM5102 muss kann in bestimmten vielfachen der Samplingrate fs gewählt werden. 
Die System CLock ist noetig für die digitalen Interpolationsfilter und die erweiterten Segment DAC Modulatoren.

Auf S24 im Datenblatt ist eine Tabelle dargestellt, mit welchen Systemclocks der PCM5102 auf der jeweiligen Samplingfrequenz betrieben werden kann. 
Unser Modul wird erst einmal Samples mit einer Samplerate von 44.1kHz abspielen/aufnehmen. Eine Erweiterung wäre die automatische Erkennung der Samplingfrequenz aus dem PCM-Header, und dann die Konfiguration des SCK Timers.

Der angestrebte Wert ist  SCK = 45.1584MHz bei fs = 44.1kHZ

Die Berechnung der SCK (in STM32 CubeMX MCK) wird in STM32 CubeMX in der "Clock Configuration" Sektion vorgenommen. Hier ist es die `PLLI2SCLK`.
Ein Faktor von *316/7 hat sich als Einstellung mit einem Fehler von nur 0.19% als sehr gut herausgestellt.
