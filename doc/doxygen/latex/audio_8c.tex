\doxysection{f401\+\_\+sd\+\_\+card\+\_\+audio\+\_\+codec\+\_\+test/\+Core/\+Src/audio.c File Reference}
\hypertarget{audio_8c}{}\label{audio_8c}\index{f401\_sd\_card\_audio\_codec\_test/Core/Src/audio.c@{f401\_sd\_card\_audio\_codec\_test/Core/Src/audio.c}}


Audio playback and processing functions.  


{\ttfamily \#include "{}audio.\+h"{}}\newline
\doxysubsubsection*{Macros}
\begin{DoxyCompactItemize}
\item 
\Hypertarget{audio_8c_a597174ea5be6ca475ea0fddbef1e9af7}\label{audio_8c_a597174ea5be6ca475ea0fddbef1e9af7} 
\#define {\bfseries SINE\+\_\+\+TABLE\+\_\+\+SIZE}~256
\end{DoxyCompactItemize}
\doxysubsubsection*{Functions}
\begin{DoxyCompactItemize}
\item 
\Hypertarget{audio_8c_a108a166a0c4a22e7e53ecb8d78f71b4d}\label{audio_8c_a108a166a0c4a22e7e53ecb8d78f71b4d} 
void {\bfseries init\+Sine\+Table} ()
\item 
void \mbox{\hyperlink{audio_8c_a5bef3c73683b81e822368c9029e495bc}{HAL\+\_\+\+I2\+S\+\_\+\+Tx\+Half\+Cplt\+Callback}} (I2\+S\+\_\+\+Handle\+Type\+Def \texorpdfstring{$\ast$}{*}hi2s)
\begin{DoxyCompactList}\small\item\em Called when the first half of the I2S buffer is transmitted. \end{DoxyCompactList}\item 
void \mbox{\hyperlink{audio_8c_a1ef4021384eddbd41ca60454a2483bf3}{HAL\+\_\+\+I2\+S\+\_\+\+Tx\+Cplt\+Callback}} (I2\+S\+\_\+\+Handle\+Type\+Def \texorpdfstring{$\ast$}{*}hi2s)
\begin{DoxyCompactList}\small\item\em Called when the entire I2S buffer is transmitted. \end{DoxyCompactList}\item 
void \mbox{\hyperlink{audio_8c_aa4c711f3eafe603209a8799713c0e3fa}{generate\+Sine\+Wave}} (double frequency)
\begin{DoxyCompactList}\small\item\em Populates half of the DAC buffer with a sine wave using a lookup table. \end{DoxyCompactList}\item 
uint16\+\_\+t \mbox{\hyperlink{audio_8c_a82f747c52fbd6fdde56b5fbd396e47f9}{fill\+Half\+Buffer\+From\+SD}} (\mbox{\hyperlink{structWavPlayer}{Wav\+Player}} \texorpdfstring{$\ast$}{*}player, bool pitched)
\begin{DoxyCompactList}\small\item\em Fills half of the buffer with audio samples from an SD file. \end{DoxyCompactList}\item 
void \mbox{\hyperlink{audio_8c_a4a83b5cae5b3b91dbcee7c3665ec5400}{set\+Pitch\+Factor}} (float new\+Pitch\+Factor)
\begin{DoxyCompactList}\small\item\em Sets a new pitch factor for audio playback. \end{DoxyCompactList}\end{DoxyCompactItemize}
\doxysubsubsection*{Variables}
\begin{DoxyCompactItemize}
\item 
\Hypertarget{audio_8c_a8eb6aa74cefde2f3411b3d2c8d2fd8af}\label{audio_8c_a8eb6aa74cefde2f3411b3d2c8d2fd8af} 
bool {\bfseries dma\+\_\+data\+Ready} = false
\item 
\Hypertarget{audio_8c_aad5714e1340d0e765df04f85f40eb2d7}\label{audio_8c_aad5714e1340d0e765df04f85f40eb2d7} 
int16\+\_\+t {\bfseries dac\+Data} \mbox{[}\mbox{\hyperlink{audio_8h_a6b20d41d6252e9871430c242cb1a56e7}{BUFFER\+\_\+\+SIZE}}\mbox{]}
\item 
\Hypertarget{audio_8c_ae08eb823baf1789e45076f2996991daf}\label{audio_8c_ae08eb823baf1789e45076f2996991daf} 
int16\+\_\+t {\bfseries file\+Read\+Buf} \mbox{[}\mbox{\hyperlink{audio_8h_ac462a6384d0c07c9748976a66d7cb761}{BUFFER\+\_\+\+SIZE\+\_\+\+INPUT}}\mbox{]}
\item 
\Hypertarget{audio_8c_af4586a80dff4afb4842b611aa1c37f4e}\label{audio_8c_af4586a80dff4afb4842b611aa1c37f4e} 
volatile int16\+\_\+t \texorpdfstring{$\ast$}{*} {\bfseries out\+Buf\+Ptr} = \&dac\+Data\mbox{[}0\mbox{]}
\item 
\Hypertarget{audio_8c_acb9de890fea6817ea13c3e5b35bb263b}\label{audio_8c_acb9de890fea6817ea13c3e5b35bb263b} 
volatile bool {\bfseries pitch\+Changed} = false
\item 
\Hypertarget{audio_8c_adc322ef407a251a03fca07817b2d8029}\label{audio_8c_adc322ef407a251a03fca07817b2d8029} 
int16\+\_\+t {\bfseries sine\+Table} \mbox{[}SINE\+\_\+\+TABLE\+\_\+\+SIZE\mbox{]}
\end{DoxyCompactItemize}


\doxysubsection{Detailed Description}
Audio playback and processing functions. 

Implements functions for audio playback using DMA and I2S, including sine wave generation, buffer management, and pitch adjustment. Also provides a precomputed sine wave table for testing the Codec. 

\doxysubsection{Function Documentation}
\Hypertarget{audio_8c_a82f747c52fbd6fdde56b5fbd396e47f9}\index{audio.c@{audio.c}!fillHalfBufferFromSD@{fillHalfBufferFromSD}}
\index{fillHalfBufferFromSD@{fillHalfBufferFromSD}!audio.c@{audio.c}}
\doxysubsubsection{\texorpdfstring{fillHalfBufferFromSD()}{fillHalfBufferFromSD()}}
{\footnotesize\ttfamily \label{audio_8c_a82f747c52fbd6fdde56b5fbd396e47f9} 
uint16\+\_\+t fill\+Half\+Buffer\+From\+SD (\begin{DoxyParamCaption}\item[{\mbox{\hyperlink{structWavPlayer}{Wav\+Player}} \texorpdfstring{$\ast$}{*}}]{player}{, }\item[{bool}]{pitched}{}\end{DoxyParamCaption})}



Fills half of the buffer with audio samples from an SD file. 

The function reads audio samples from an SD card file into a buffer. If the {\ttfamily pitched} parameter is true, it adjusts the number of samples to account for pitch shifting. It ensures the number of samples is even and reads the data into {\ttfamily file\+Read\+Buf}.


\begin{DoxyParams}{Parameters}
{\em player} & Pointer to a {\ttfamily \doxylink{structWavPlayer}{Wav\+Player}} structure containing file information and pitch factor. \\
\hline
{\em pitched} & Flag indicating whether pitch shifting should be applied.\\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
The number of bytes actually read from the file. 
\end{DoxyReturn}
\Hypertarget{audio_8c_aa4c711f3eafe603209a8799713c0e3fa}\index{audio.c@{audio.c}!generateSineWave@{generateSineWave}}
\index{generateSineWave@{generateSineWave}!audio.c@{audio.c}}
\doxysubsubsection{\texorpdfstring{generateSineWave()}{generateSineWave()}}
{\footnotesize\ttfamily \label{audio_8c_aa4c711f3eafe603209a8799713c0e3fa} 
void generate\+Sine\+Wave (\begin{DoxyParamCaption}\item[{double}]{frequency}{}\end{DoxyParamCaption})}



Populates half of the DAC buffer with a sine wave using a lookup table. 

The function generates a sine wave based on the provided frequency. It uses a lookup table to fill the DAC buffer with sine values and manages the phase index for the waveform. It waits for the DMA to be ready before updating the buffer.


\begin{DoxyParams}{Parameters}
{\em frequency} & Desired frequency of the sine wave. \\
\hline
\end{DoxyParams}
\texorpdfstring{$<$}{<} Retains the index between function calls\Hypertarget{audio_8c_a1ef4021384eddbd41ca60454a2483bf3}\index{audio.c@{audio.c}!HAL\_I2S\_TxCpltCallback@{HAL\_I2S\_TxCpltCallback}}
\index{HAL\_I2S\_TxCpltCallback@{HAL\_I2S\_TxCpltCallback}!audio.c@{audio.c}}
\doxysubsubsection{\texorpdfstring{HAL\_I2S\_TxCpltCallback()}{HAL\_I2S\_TxCpltCallback()}}
{\footnotesize\ttfamily \label{audio_8c_a1ef4021384eddbd41ca60454a2483bf3} 
void HAL\+\_\+\+I2\+S\+\_\+\+Tx\+Cplt\+Callback (\begin{DoxyParamCaption}\item[{I2\+S\+\_\+\+Handle\+Type\+Def \texorpdfstring{$\ast$}{*}}]{hi2s}{}\end{DoxyParamCaption})}



Called when the entire I2S buffer is transmitted. 

Updates the buffer pointer to the second half of {\ttfamily dac\+Data} and sets the DMA data ready flag.


\begin{DoxyParams}{Parameters}
{\em hi2s} & Pointer to the I2S handle structure. \\
\hline
\end{DoxyParams}
\Hypertarget{audio_8c_a5bef3c73683b81e822368c9029e495bc}\index{audio.c@{audio.c}!HAL\_I2S\_TxHalfCpltCallback@{HAL\_I2S\_TxHalfCpltCallback}}
\index{HAL\_I2S\_TxHalfCpltCallback@{HAL\_I2S\_TxHalfCpltCallback}!audio.c@{audio.c}}
\doxysubsubsection{\texorpdfstring{HAL\_I2S\_TxHalfCpltCallback()}{HAL\_I2S\_TxHalfCpltCallback()}}
{\footnotesize\ttfamily \label{audio_8c_a5bef3c73683b81e822368c9029e495bc} 
void HAL\+\_\+\+I2\+S\+\_\+\+Tx\+Half\+Cplt\+Callback (\begin{DoxyParamCaption}\item[{I2\+S\+\_\+\+Handle\+Type\+Def \texorpdfstring{$\ast$}{*}}]{hi2s}{}\end{DoxyParamCaption})}



Called when the first half of the I2S buffer is transmitted. 

Updates the buffer pointer to the start of {\ttfamily dac\+Data} and sets the DMA data ready flag.


\begin{DoxyParams}{Parameters}
{\em hi2s} & Pointer to the I2S handle structure. \\
\hline
\end{DoxyParams}
\Hypertarget{audio_8c_a4a83b5cae5b3b91dbcee7c3665ec5400}\index{audio.c@{audio.c}!setPitchFactor@{setPitchFactor}}
\index{setPitchFactor@{setPitchFactor}!audio.c@{audio.c}}
\doxysubsubsection{\texorpdfstring{setPitchFactor()}{setPitchFactor()}}
{\footnotesize\ttfamily \label{audio_8c_a4a83b5cae5b3b91dbcee7c3665ec5400} 
void set\+Pitch\+Factor (\begin{DoxyParamCaption}\item[{float}]{new\+Pitch\+Factor}{}\end{DoxyParamCaption})}



Sets a new pitch factor for audio playback. 

Updates the global pitch factor and marks it as changed. Interrupts are temporarily disabled to ensure thread safety during the update.


\begin{DoxyParams}{Parameters}
{\em new\+Pitch\+Factor} & The new pitch factor to set. \\
\hline
\end{DoxyParams}
