\doxysection{neuronal\+\_\+network/esp\+\_\+cubeai\+\_\+test/\+Core/\+Src/audio\+\_\+classification.c File Reference}
\hypertarget{esp__cubeai__test_2Core_2Src_2audio__classification_8c}{}\label{esp__cubeai__test_2Core_2Src_2audio__classification_8c}\index{neuronal\_network/esp\_cubeai\_test/Core/Src/audio\_classification.c@{neuronal\_network/esp\_cubeai\_test/Core/Src/audio\_classification.c}}


Audio classification implementation for embedded systems via stm32cube.\+ai (for testing purposes).  


{\ttfamily \#include "{}audio\+\_\+classification.\+h"{}}\newline
{\ttfamily \#include "{}featurescaler.\+h"{}}\newline
{\ttfamily \#include $<$math.\+h$>$}\newline
{\ttfamily \#include "{}feature\+\_\+extraction.\+h"{}}\newline
{\ttfamily \#include "{}network\+\_\+1.\+h"{}}\newline
{\ttfamily \#include "{}network\+\_\+1\+\_\+data.\+h"{}}\newline
{\ttfamily \#include "{}network\+\_\+1\+\_\+config.\+h"{}}\newline
{\ttfamily \#include "{}network\+\_\+1\+\_\+data\+\_\+params.\+h"{}}\newline
{\ttfamily \#include "{}utils.\+h"{}}\newline
\doxysubsubsection*{Functions}
\begin{DoxyCompactItemize}
\item 
int \mbox{\hyperlink{esp__cubeai__test_2Core_2Src_2audio__classification_8c_adb2fd0c7b1a7e587cae71795dbe373fd}{init\+\_\+nn}} ()
\begin{DoxyCompactList}\small\item\em Initializes the neural network for audio classification. \end{DoxyCompactList}\item 
int \mbox{\hyperlink{esp__cubeai__test_2Core_2Src_2audio__classification_8c_a32ec07122bc40c96ca43c55ce75a2c28}{run\+\_\+nn\+\_\+classification}} (ai\+\_\+float \texorpdfstring{$\ast$}{*}p\+Spectrogram, ai\+\_\+float \texorpdfstring{$\ast$}{*}classification\+\_\+result)
\begin{DoxyCompactList}\small\item\em Runs the neural network to classify audio data based on the provided spectrogram. \end{DoxyCompactList}\item 
void \mbox{\hyperlink{esp__cubeai__test_2Core_2Src_2audio__classification_8c_a16f618da32af7135f1dffb945d22f94e}{test\+\_\+call\+\_\+classification}} ()
\begin{DoxyCompactList}\small\item\em Tests the classification process by simulating the generation and processing of a spectrogram without actually requiring input data. Was used for previous tests. \end{DoxyCompactList}\item 
void \mbox{\hyperlink{esp__cubeai__test_2Core_2Src_2audio__classification_8c_af914bc6d2d41467a12e3d7aa2febea8a}{Preprocessing\+\_\+\+Init}} (void)
\begin{DoxyCompactList}\small\item\em Initializes the mel-\/spectrogram calculation lib which is part of the audio preprocessing. \end{DoxyCompactList}\item 
void \mbox{\hyperlink{esp__cubeai__test_2Core_2Src_2audio__classification_8c_aaefcaf181ee79b12dbc3120610d78ea5}{frame\+\_\+subsamples}} (float32\+\_\+t \texorpdfstring{$\ast$}{*}subsample)
\begin{DoxyCompactList}\small\item\em Splits an audiosubsample into overlapping frames ready for further processing. \end{DoxyCompactList}\item 
void \mbox{\hyperlink{esp__cubeai__test_2Core_2Src_2audio__classification_8c_a40470456cbea6561d0190bec8cf5ecdd}{preprocess\+\_\+frame}} (float \texorpdfstring{$\ast$}{*}p\+Frame)
\begin{DoxyCompactList}\small\item\em Processes a single audio frame and incorporates it into the spectrogram. \end{DoxyCompactList}\item 
void \mbox{\hyperlink{esp__cubeai__test_2Core_2Src_2audio__classification_8c_ac4b6da8a976d7d6e0bb32c0eecb98d7b}{process\+\_\+subsample}} (float \texorpdfstring{$\ast$}{*}p\+Spectrogram)
\begin{DoxyCompactList}\small\item\em Processes a complete spectrogram, runs classification, and measures performance. \end{DoxyCompactList}\item 
void \mbox{\hyperlink{esp__cubeai__test_2Core_2Src_2audio__classification_8c_a6346bd634560cfec3a2cf6a21e99ec42}{Power\+To\+Db}} (float \texorpdfstring{$\ast$}{*}p\+Spectrogram)
\begin{DoxyCompactList}\small\item\em Converts power values in a spectrogram to decibels (dB). \end{DoxyCompactList}\end{DoxyCompactItemize}
\doxysubsubsection*{Variables}
\begin{DoxyCompactItemize}
\item 
\Hypertarget{esp__cubeai__test_2Core_2Src_2audio__classification_8c_acaab4df7cc0db52d6db6dd43a6d355ad}\label{esp__cubeai__test_2Core_2Src_2audio__classification_8c_acaab4df7cc0db52d6db6dd43a6d355ad} 
ai\+\_\+handle {\bfseries network}
\begin{DoxyCompactList}\small\item\em Handle to the neural network (stm32cube.\+ai) instance used for audio classification. \end{DoxyCompactList}\item 
\Hypertarget{esp__cubeai__test_2Core_2Src_2audio__classification_8c_ad77044b96e2a27076019a13bd946f376}\label{esp__cubeai__test_2Core_2Src_2audio__classification_8c_ad77044b96e2a27076019a13bd946f376} 
ai\+\_\+u8 {\bfseries activations} \mbox{[}AI\+\_\+\+NETWORK\+\_\+1\+\_\+\+DATA\+\_\+\+ACTIVATIONS\+\_\+\+SIZE\mbox{]}
\begin{DoxyCompactList}\small\item\em Buffer for storing activation data required by stm32cube.\+ai. \end{DoxyCompactList}\item 
\Hypertarget{esp__cubeai__test_2Core_2Src_2audio__classification_8c_a8b50f4d34c488810a349fcdc358221a6}\label{esp__cubeai__test_2Core_2Src_2audio__classification_8c_a8b50f4d34c488810a349fcdc358221a6} 
ai\+\_\+buffer \texorpdfstring{$\ast$}{*} {\bfseries ai\+\_\+input}
\begin{DoxyCompactList}\small\item\em Pointer to the input buffer of the stm32cube.\+ai. \end{DoxyCompactList}\item 
\Hypertarget{esp__cubeai__test_2Core_2Src_2audio__classification_8c_a8b53e90f2beb83b673adad35da65d713}\label{esp__cubeai__test_2Core_2Src_2audio__classification_8c_a8b53e90f2beb83b673adad35da65d713} 
ai\+\_\+buffer \texorpdfstring{$\ast$}{*} {\bfseries ai\+\_\+output}
\begin{DoxyCompactList}\small\item\em Pointer to the output buffer of stm32cube.\+ai, where classification results are stored. \end{DoxyCompactList}\item 
\Hypertarget{esp__cubeai__test_2Core_2Src_2audio__classification_8c_a503416647290a6138d19561b0b4c0757}\label{esp__cubeai__test_2Core_2Src_2audio__classification_8c_a503416647290a6138d19561b0b4c0757} 
ai\+\_\+float {\bfseries spectrogram} \mbox{[}AI\+\_\+\+NETWORK\+\_\+1\+\_\+\+IN\+\_\+1\+\_\+\+SIZE\mbox{]}
\begin{DoxyCompactList}\small\item\em Array to hold the input spectrogram data that feeds into the neural network. \end{DoxyCompactList}\item 
\Hypertarget{esp__cubeai__test_2Core_2Src_2audio__classification_8c_aa3bea72754aa19c752200ed543b8709f}\label{esp__cubeai__test_2Core_2Src_2audio__classification_8c_aa3bea72754aa19c752200ed543b8709f} 
float {\bfseries ai\+Out\+Data} \mbox{[}AI\+\_\+\+NETWORK\+\_\+1\+\_\+\+OUT\+\_\+1\+\_\+\+SIZE\mbox{]} = \{0.\+0, 0.\+0, 0.\+0, 0.\+0, 0.\+0\}
\begin{DoxyCompactList}\small\item\em Output data from the neural network, containing classification results. \end{DoxyCompactList}\item 
\Hypertarget{esp__cubeai__test_2Core_2Src_2audio__classification_8c_a375402b5fe21bff9f8044d0d23a95ee4}\label{esp__cubeai__test_2Core_2Src_2audio__classification_8c_a375402b5fe21bff9f8044d0d23a95ee4} 
uint32\+\_\+t {\bfseries spectrogram\+\_\+col\+\_\+index} = 0
\begin{DoxyCompactList}\small\item\em Index to track the current column in the spectrogram buffer during data preprocessing. \end{DoxyCompactList}\item 
\Hypertarget{esp__cubeai__test_2Core_2Src_2audio__classification_8c_abaccaa73da8dd7d59fc3d6465440aa1f}\label{esp__cubeai__test_2Core_2Src_2audio__classification_8c_abaccaa73da8dd7d59fc3d6465440aa1f} 
float32\+\_\+t {\bfseries mel\+\_\+spectrogram\+\_\+column\+\_\+buffer} \mbox{[}SPECTROGRAM\+\_\+\+ROWS\mbox{]}
\end{DoxyCompactItemize}


\doxysubsection{Detailed Description}
Audio classification implementation for embedded systems via stm32cube.\+ai (for testing purposes). 

This file implements the methods and algorithms required for audio classification using neural networks on embedded systems via stm32cube.\+ai. It includes initialization and execution of a neural network, preprocessing of audio data to generate spectrograms, and the handling of neural network output.

\begin{DoxyDate}{Date}
June 20, 2024 
\end{DoxyDate}
\begin{DoxyAuthor}{Author}
Leon Braungardt 
\end{DoxyAuthor}


\doxysubsection{Function Documentation}
\Hypertarget{esp__cubeai__test_2Core_2Src_2audio__classification_8c_aaefcaf181ee79b12dbc3120610d78ea5}\index{audio\_classification.c@{audio\_classification.c}!frame\_subsamples@{frame\_subsamples}}
\index{frame\_subsamples@{frame\_subsamples}!audio\_classification.c@{audio\_classification.c}}
\doxysubsubsection{\texorpdfstring{frame\_subsamples()}{frame\_subsamples()}}
{\footnotesize\ttfamily \label{esp__cubeai__test_2Core_2Src_2audio__classification_8c_aaefcaf181ee79b12dbc3120610d78ea5} 
void frame\+\_\+subsamples (\begin{DoxyParamCaption}\item[{float32\+\_\+t \texorpdfstring{$\ast$}{*}}]{subsample}{}\end{DoxyParamCaption})}



Splits an audiosubsample into overlapping frames ready for further processing. 

This function segments an audiosubsample into frames 1024 samples with a 512 sample overlap, preparing them for feature extraction (spectrogram calculation). Each frame is extracted based on the hop length and frame length definitions, with zero-\/padding applied where necessary. The frames are then passed to the {\ttfamily preprocess\+\_\+frame} function for following processing steps.


\begin{DoxyParams}{Parameters}
{\em float32\+\_\+t\texorpdfstring{$\ast$}{*}} & subsample Pointer to the array containing the audio subsample data. \\
\hline
\end{DoxyParams}
\Hypertarget{esp__cubeai__test_2Core_2Src_2audio__classification_8c_adb2fd0c7b1a7e587cae71795dbe373fd}\index{audio\_classification.c@{audio\_classification.c}!init\_nn@{init\_nn}}
\index{init\_nn@{init\_nn}!audio\_classification.c@{audio\_classification.c}}
\doxysubsubsection{\texorpdfstring{init\_nn()}{init\_nn()}}
{\footnotesize\ttfamily \label{esp__cubeai__test_2Core_2Src_2audio__classification_8c_adb2fd0c7b1a7e587cae71795dbe373fd} 
int init\+\_\+nn (\begin{DoxyParamCaption}\item[{void}]{}{}\end{DoxyParamCaption})}



Initializes the neural network for audio classification. 

This function sets up the neural network by creating an instance of the model and initializing it with the required activation buffers. It retrieves the necessary input and output buffers for processing the audio data. Error handling is incorporated to manage potential initialization failures.

\begin{DoxyReturn}{Returns}
int Returns 0 on successful initialization, or -\/1 if an error occurs during the network creation or initialization.
\end{DoxyReturn}
\begin{DoxyNote}{Note}
Drived from \href{https://wiki.st.com/stm32mcu/wiki/AI:How_to_perform_motion_sensing_on_STM32L4_IoTnode\#Create_an_STM32Cube-AI_application_using_X-CUBE-AI}{\texttt{ https\+://wiki.\+st.\+com/stm32mcu/wiki/\+AI\+:\+How\+\_\+to\+\_\+perform\+\_\+motion\+\_\+sensing\+\_\+on\+\_\+\+STM32\+L4\+\_\+\+Io\+Tnode\#\+Create\+\_\+an\+\_\+\+STM32\+Cube-\/\+AI\+\_\+application\+\_\+using\+\_\+\+X-\/\+CUBE-\/\+AI}} 
\end{DoxyNote}
\Hypertarget{esp__cubeai__test_2Core_2Src_2audio__classification_8c_a6346bd634560cfec3a2cf6a21e99ec42}\index{audio\_classification.c@{audio\_classification.c}!PowerToDb@{PowerToDb}}
\index{PowerToDb@{PowerToDb}!audio\_classification.c@{audio\_classification.c}}
\doxysubsubsection{\texorpdfstring{PowerToDb()}{PowerToDb()}}
{\footnotesize\ttfamily \label{esp__cubeai__test_2Core_2Src_2audio__classification_8c_a6346bd634560cfec3a2cf6a21e99ec42} 
void Power\+To\+Db (\begin{DoxyParamCaption}\item[{float \texorpdfstring{$\ast$}{*}}]{p\+Spectrogram}{}\end{DoxyParamCaption})}



Converts power values in a spectrogram to decibels (dB). 

This function scans the spectrogram for the maximum power value to use as a reference for converting all power values to dB scale. It handles special cases where the maximum power is zero (silence) by setting all dB values to -\/80 dB to avoid division by zero. Values below -\/80 dB or resulting in NaN are also set to -\/80 dB to ensure numerical stability.


\begin{DoxyParams}{Parameters}
{\em float} & \texorpdfstring{$\ast$}{*}p\+Spectrogram Pointer to the spectrogram data array. \\
\hline
\end{DoxyParams}
\Hypertarget{esp__cubeai__test_2Core_2Src_2audio__classification_8c_a40470456cbea6561d0190bec8cf5ecdd}\index{audio\_classification.c@{audio\_classification.c}!preprocess\_frame@{preprocess\_frame}}
\index{preprocess\_frame@{preprocess\_frame}!audio\_classification.c@{audio\_classification.c}}
\doxysubsubsection{\texorpdfstring{preprocess\_frame()}{preprocess\_frame()}}
{\footnotesize\ttfamily \label{esp__cubeai__test_2Core_2Src_2audio__classification_8c_a40470456cbea6561d0190bec8cf5ecdd} 
void preprocess\+\_\+frame (\begin{DoxyParamCaption}\item[{float \texorpdfstring{$\ast$}{*}}]{p\+Frame}{}\end{DoxyParamCaption})}



Processes a single audio frame and incorporates it into the spectrogram. 

This function takes an audio frame, computes its Mel-\/scaled spectrogram column, and appends this column to the ongoing spectrogram array. Once the spectrogram is filled with the number of columns determined by SPECTROGRAM\+\_\+\+COLS, it triggers the calculation of the spectrogram.


\begin{DoxyParams}{Parameters}
{\em float\texorpdfstring{$\ast$}{*}} & p\+Frame Pointer to the array containing the audio frame data, which is 1024 samples in length.\\
\hline
\end{DoxyParams}
\begin{DoxyNote}{Note}
This function updates the global {\ttfamily spectrogram\+\_\+col\+\_\+index} to manage the position within the spectrogram array. When the spectrogram array is full, it calls {\ttfamily process\+\_\+subsample} to handle the filled spectrogram and resets the index for new data. 
\end{DoxyNote}
\Hypertarget{esp__cubeai__test_2Core_2Src_2audio__classification_8c_af914bc6d2d41467a12e3d7aa2febea8a}\index{audio\_classification.c@{audio\_classification.c}!Preprocessing\_Init@{Preprocessing\_Init}}
\index{Preprocessing\_Init@{Preprocessing\_Init}!audio\_classification.c@{audio\_classification.c}}
\doxysubsubsection{\texorpdfstring{Preprocessing\_Init()}{Preprocessing\_Init()}}
{\footnotesize\ttfamily \label{esp__cubeai__test_2Core_2Src_2audio__classification_8c_af914bc6d2d41467a12e3d7aa2febea8a} 
void Preprocessing\+\_\+\+Init (\begin{DoxyParamCaption}\item[{void}]{}{}\end{DoxyParamCaption})}



Initializes the mel-\/spectrogram calculation lib which is part of the audio preprocessing. 

This function sets up the components needed for generating Mel spectrograms from audio data.

\begin{DoxyNote}{Note}
Derived from the FP-\/\+AI-\/\+SENSING feature pack\+: \href{https://www.st.com/en/embedded-software/fp-ai-sensing1.html}{\texttt{ https\+://www.\+st.\+com/en/embedded-\/software/fp-\/ai-\/sensing1.\+html}} 
\end{DoxyNote}
\Hypertarget{esp__cubeai__test_2Core_2Src_2audio__classification_8c_ac4b6da8a976d7d6e0bb32c0eecb98d7b}\index{audio\_classification.c@{audio\_classification.c}!process\_subsample@{process\_subsample}}
\index{process\_subsample@{process\_subsample}!audio\_classification.c@{audio\_classification.c}}
\doxysubsubsection{\texorpdfstring{process\_subsample()}{process\_subsample()}}
{\footnotesize\ttfamily \label{esp__cubeai__test_2Core_2Src_2audio__classification_8c_ac4b6da8a976d7d6e0bb32c0eecb98d7b} 
void process\+\_\+subsample (\begin{DoxyParamCaption}\item[{float \texorpdfstring{$\ast$}{*}}]{p\+Spectrogram}{}\end{DoxyParamCaption})}



Processes a complete spectrogram, runs classification, and measures performance. 

This function is responsible for converting a power spectrogram into decibel scale, running the neural network to classify the audio data, and measuring the processing time in CPU cycles and milliseconds. It performs a series of operations\+: conversion of spectrogram values with the predefined scaler (imitating the standardization), neural network classification and performance tracking. The classification results are then contained in ai\+Out\+Data.


\begin{DoxyParams}{Parameters}
{\em float\texorpdfstring{$\ast$}{*}} & p\+Spectrogram Pointer to the array holding the complete spectrogram data that will be processed and classified. \\
\hline
\end{DoxyParams}
\Hypertarget{esp__cubeai__test_2Core_2Src_2audio__classification_8c_a32ec07122bc40c96ca43c55ce75a2c28}\index{audio\_classification.c@{audio\_classification.c}!run\_nn\_classification@{run\_nn\_classification}}
\index{run\_nn\_classification@{run\_nn\_classification}!audio\_classification.c@{audio\_classification.c}}
\doxysubsubsection{\texorpdfstring{run\_nn\_classification()}{run\_nn\_classification()}}
{\footnotesize\ttfamily \label{esp__cubeai__test_2Core_2Src_2audio__classification_8c_a32ec07122bc40c96ca43c55ce75a2c28} 
int run\+\_\+nn\+\_\+classification (\begin{DoxyParamCaption}\item[{ai\+\_\+float \texorpdfstring{$\ast$}{*}}]{p\+Spectrogram}{, }\item[{ai\+\_\+float \texorpdfstring{$\ast$}{*}}]{classification\+\_\+result}{}\end{DoxyParamCaption})}



Runs the neural network to classify audio data based on the provided spectrogram. 

This function takes a pointer to a spectrogram array, processes it by normalizing with pre-\/calculated mean and standard deviation values, and then feeds it into the neural network. The output from the neural network is stored in the provided classification\+\_\+result array.


\begin{DoxyParams}{Parameters}
{\em ai\+\_\+float\texorpdfstring{$\ast$}{*}} & p\+Spectrogram Pointer to the input spectrogram array. \\
\hline
{\em ai\+\_\+float\texorpdfstring{$\ast$}{*}} & classification\+\_\+result Pointer to the array where the neural network\textquotesingle{}s output (classification results) will be stored.\\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
int Returns 0 on successful classification, or -\/1 if an error occurs during the network run or if the network handle is null. 
\end{DoxyReturn}
\Hypertarget{esp__cubeai__test_2Core_2Src_2audio__classification_8c_a16f618da32af7135f1dffb945d22f94e}\index{audio\_classification.c@{audio\_classification.c}!test\_call\_classification@{test\_call\_classification}}
\index{test\_call\_classification@{test\_call\_classification}!audio\_classification.c@{audio\_classification.c}}
\doxysubsubsection{\texorpdfstring{test\_call\_classification()}{test\_call\_classification()}}
{\footnotesize\ttfamily \label{esp__cubeai__test_2Core_2Src_2audio__classification_8c_a16f618da32af7135f1dffb945d22f94e} 
void test\+\_\+call\+\_\+classification (\begin{DoxyParamCaption}\item[{void}]{}{}\end{DoxyParamCaption})}



Tests the classification process by simulating the generation and processing of a spectrogram without actually requiring input data. Was used for previous tests. 

\begin{DoxyNote}{Note}
The loop fixed at 32 iterations represents a placeholder for actual Mel spectrogram calculation based on audio input. 
\end{DoxyNote}
